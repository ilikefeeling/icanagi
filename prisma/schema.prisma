// Prisma Schema for icanagi AI Marketplace
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Product Models
// ============================================

model Product {
  id          String   @id @default(uuid())
  name        String
  description String   @db.Text // Markdown 지원
  category    ProductCategory
  
  // 이미지 및 URL
  thumbnailUrl String?
  serviceUrl   String
  demoUrl      String? // 데모 페이지 링크
  videoUrl     String? // 데모 영상 URL
  
  // 가격 정책
  pricingTier PricingTier @default(FREE)
  price       Decimal?    @db.Decimal(10, 2) // 유료일 경우 가격
  
  // 기술 명세
  techStack   String[] // 사용 기술 (예: ["GPT-4", "Next.js"])
  apiEndpoint String? // API 엔드포인트
  
  // 상태 관리
  status      ProductStatus @default(DRAFT)
  
  // SEO 최적화
  slug            String  @unique
  metaTitle       String?
  metaDescription String?
  
  // 통계 추적
  viewCount  Int @default(0)
  clickCount Int @default(0)
  
  // 태그 관계
  tags ProductTag[]
  
  // 작성자 관계
  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)
  
  // 타임스탬프
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // 인덱스 최적화
  @@index([category, status])
  @@index([slug])
  @@index([createdAt])
  @@index([pricingTier])
}

enum ProductCategory {
  APP       // 애플리케이션
  SAAS      // SaaS 서비스
  AI_AGENT  // AI 에이전트
  TOOL      // 도구/유틸리티
}

enum ProductStatus {
  DRAFT     // 임시저장
  PUBLISHED // 공개
  ARCHIVED  // 보관됨
}

enum PricingTier {
  FREE      // 무료
  FREEMIUM  // 기본 무료 + 유료 기능
  PAID      // 유료
  ENTERPRISE // 기업용 (문의 필요)
}

// 태그 시스템 (유연한 필터링)
model ProductTag {
  id        String    @id @default(uuid())
  name      String    @unique
  slug      String    @unique
  products  Product[]
  
  createdAt DateTime @default(now())
  
  @@index([slug])
}

// ============================================
// User & Authentication Models
// ============================================

model User {
  id            String    @id @default(uuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  
  // 역할 기반 접근 제어
  role UserRole @default(USER)
  
  // NextAuth 관계
  accounts Account[]
  sessions Session[]
  
  // 사용자가 생성한 상품
  products Product[]
  
  // 타임스탬프
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([email])
  @@index([role])
}

enum UserRole {
  USER  // 일반 사용자
  ADMIN // 관리자
}

// NextAuth 필수 모델
model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String  // "google" 또는 "kakao"
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
